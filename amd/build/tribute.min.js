/* !
* tribute https://github.com/zurb/tribute
* A cross-browser @mention engine written in ES6, no dependencies.
* @version 5.1.3
* @copyright 2017-2020 ZURB, Inc. 2014 Jeff Collins, 2012 Matt York
* @license: MIT
*/
var global,factory;global=window,factory=function(){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _slicedToArray(arr,i){return function(arr){if(Array.isArray(arr))return arr}(arr)||function(arr,i){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(arr)){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}(arr,i)||function(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Object"===n&&o.constructor&&(n=o.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}(arr,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}if(Array.prototype.find||(Array.prototype.find=function(predicate){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof predicate)throw new TypeError("predicate must be a function");for(var value,list=Object(this),length=list.length>>>0,thisArg=arguments[1],i=0;i<length;i++)if(value=list[i],predicate.call(thisArg,value,i,list))return value}),window&&"function"!=typeof window.CustomEvent){var CustomEvent$1=function(event,params){params=params||{bubbles:!1,cancelable:!1,detail:void 0};var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail),evt};void 0!==window.Event&&(CustomEvent$1.prototype=window.Event.prototype),window.CustomEvent=CustomEvent$1}var TributeEvents=function(){function TributeEvents(tribute){_classCallCheck(this,TributeEvents),this.tribute=tribute,this.tribute.events=this}return _createClass(TributeEvents,[{key:"bind",value:function(element){element.boundKeydown=this.keydown.bind(element,this),element.boundKeyup=this.keyup.bind(element,this),element.boundInput=this.input.bind(element,this),element.addEventListener("keydown",element.boundKeydown,!1),element.addEventListener("keyup",element.boundKeyup,!1),element.addEventListener("input",element.boundInput,!1)}},{key:"unbind",value:function(element){element.removeEventListener("keydown",element.boundKeydown,!1),element.removeEventListener("keyup",element.boundKeyup,!1),element.removeEventListener("input",element.boundInput,!1),delete element.boundKeydown,delete element.boundKeyup,delete element.boundInput}},{key:"keydown",value:function(instance,event){instance.shouldDeactivate(event)&&(instance.tribute.isActive=!1,instance.tribute.hideMenu());var element=this;instance.commandEvent=!1,TributeEvents.keys().forEach((function(o){o.key===event.keyCode&&(instance.commandEvent=!0,instance.callbacks()[o.value.toLowerCase()](event,element))}))}},{key:"input",value:function(instance,event){instance.inputEvent=!0,instance.keyup.call(this,instance,event)}},{key:"click",value:function(instance,event){var tribute=instance.tribute;if(tribute.menu&&tribute.menu.contains(event.target)){var li=event.target;for(event.preventDefault(),event.stopPropagation();"li"!==li.nodeName.toLowerCase();)if(!(li=li.parentNode)||li===tribute.menu)throw new Error("cannot find the <li> container for the click");tribute.selectItemAtIndex(li.getAttribute("data-index"),event),tribute.hideMenu()}else tribute.current.element&&!tribute.current.externalTrigger&&(tribute.current.externalTrigger=!1,setTimeout((function(){return tribute.hideMenu()})))}},{key:"keyup",value:function(instance,event){if(instance.inputEvent&&(instance.inputEvent=!1),instance.updateSelection(this),27!==event.keyCode){if(!instance.tribute.allowSpaces&&instance.tribute.hasTrailingSpace)return instance.tribute.hasTrailingSpace=!1,instance.commandEvent=!0,void instance.callbacks().space(event,this);if(!instance.tribute.isActive)if(instance.tribute.autocompleteMode)instance.callbacks().triggerChar(event,this,"");else{var keyCode=instance.getKeyCode(instance,this,event);if(isNaN(keyCode)||!keyCode)return;var trigger=instance.tribute.triggers().find((function(trigger){return trigger.charCodeAt(0)===keyCode}));void 0!==trigger&&instance.callbacks().triggerChar(event,this,trigger)}instance.tribute.current.mentionText.length<instance.tribute.current.collection.menuShowMinLength||((instance.tribute.current.trigger||instance.tribute.autocompleteMode)&&!1===instance.commandEvent||instance.tribute.isActive&&8===event.keyCode)&&instance.tribute.showMenuFor(this,!0)}}},{key:"shouldDeactivate",value:function(event){if(!this.tribute.isActive)return!1;if(0===this.tribute.current.mentionText.length){var eventKeyPressed=!1;return TributeEvents.keys().forEach((function(o){event.keyCode===o.key&&(eventKeyPressed=!0)})),!eventKeyPressed}return!1}},{key:"getKeyCode",value:function(instance,el,event){var tribute=instance.tribute,info=tribute.range.getTriggerInfo(!1,tribute.hasTrailingSpace,!0,tribute.allowSpaces,tribute.autocompleteMode);return!!info&&info.mentionTriggerChar.charCodeAt(0)}},{key:"updateSelection",value:function(el){this.tribute.current.element=el;var info=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);info&&(this.tribute.current.selectedPath=info.mentionSelectedPath,this.tribute.current.mentionText=info.mentionText,this.tribute.current.selectedOffset=info.mentionSelectedOffset)}},{key:"callbacks",value:function(){var _this=this;return{triggerChar:function(e,el,trigger){var tribute=_this.tribute;tribute.current.trigger=trigger;var collectionItem=tribute.collection.find((function(item){return item.trigger===trigger}));tribute.current.collection=collectionItem,tribute.current.mentionText.length>=tribute.current.collection.menuShowMinLength&&tribute.inputEvent&&tribute.showMenuFor(el,!0)},enter:function(e,el){_this.tribute.isActive&&_this.tribute.current.filteredItems&&(e.preventDefault(),e.stopPropagation(),setTimeout((function(){_this.tribute.selectItemAtIndex(_this.tribute.menuSelected,e),_this.tribute.hideMenu()}),0))},escape:function(e,el){_this.tribute.isActive&&(e.preventDefault(),e.stopPropagation(),_this.tribute.isActive=!1,_this.tribute.hideMenu())},tab:function(e,el){_this.callbacks().enter(e,el)},space:function(e,el){_this.tribute.isActive&&(_this.tribute.spaceSelectsMatch?_this.callbacks().enter(e,el):_this.tribute.allowSpaces||(e.stopPropagation(),setTimeout((function(){_this.tribute.hideMenu(),_this.tribute.isActive=!1}),0)))},up:function(e,el){if(_this.tribute.isActive&&_this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();var count=_this.tribute.current.filteredItems.length,selected=_this.tribute.menuSelected;count>selected&&selected>0?(_this.tribute.menuSelected--,_this.setActiveLi()):0===selected&&(_this.tribute.menuSelected=count-1,_this.setActiveLi(),_this.tribute.menu.scrollTop=_this.tribute.menu.scrollHeight)}},down:function(e,el){if(_this.tribute.isActive&&_this.tribute.current.filteredItems){e.preventDefault(),e.stopPropagation();var count=_this.tribute.current.filteredItems.length-1,selected=_this.tribute.menuSelected;count>selected?(_this.tribute.menuSelected++,_this.setActiveLi()):count===selected&&(_this.tribute.menuSelected=0,_this.setActiveLi(),_this.tribute.menu.scrollTop=0)}},delete:function(e,el){_this.tribute.isActive&&_this.tribute.current.mentionText.length<1?_this.tribute.hideMenu():_this.tribute.isActive&&_this.tribute.showMenuFor(el)}}}},{key:"setActiveLi",value:function(index){var lis=this.tribute.menu.querySelectorAll("li"),length=lis.length>>>0;index&&(this.tribute.menuSelected=parseInt(index));for(var i=0;i<length;i++){var li=lis[i];if(i===this.tribute.menuSelected){li.classList.add(this.tribute.current.collection.selectClass);var liClientRect=li.getBoundingClientRect(),menuClientRect=this.tribute.menu.getBoundingClientRect();if(liClientRect.bottom>menuClientRect.bottom){var scrollDistance=liClientRect.bottom-menuClientRect.bottom;this.tribute.menu.scrollTop+=scrollDistance}else if(liClientRect.top<menuClientRect.top){var _scrollDistance=menuClientRect.top-liClientRect.top;this.tribute.menu.scrollTop-=_scrollDistance}}else li.classList.remove(this.tribute.current.collection.selectClass)}}},{key:"getFullHeight",value:function(elem,includeMargin){var height=elem.getBoundingClientRect().height;if(includeMargin){var style=elem.currentStyle||window.getComputedStyle(elem);return height+parseFloat(style.marginTop)+parseFloat(style.marginBottom)}return height}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]),TributeEvents}(),TributeMenuEvents=function(){function TributeMenuEvents(tribute){_classCallCheck(this,TributeMenuEvents),this.tribute=tribute,this.tribute.menuEvents=this,this.menu=this.tribute.menu}return _createClass(TributeMenuEvents,[{key:"bind",value:function(menu){var _this=this;this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce((function(){_this.tribute.isActive&&_this.tribute.showMenuFor(_this.tribute.current.element,!1)}),300,!1),this.windowResizeEvent=this.debounce((function(){_this.tribute.isActive&&_this.tribute.range.positionMenuAtCaret(!0)}),300,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}},{key:"unbind",value:function(menu){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}},{key:"debounce",value:function(func,wait,immediate){var timeout,_arguments=arguments,_this2=this;return function(){var context=_this2,args=_arguments,callNow=immediate&&!timeout;clearTimeout(timeout),timeout=setTimeout((function(){timeout=null,immediate||func.apply(context,args)}),wait),callNow&&func.apply(context,args)}}}]),TributeMenuEvents}(),TributeRange=function(){function TributeRange(tribute){_classCallCheck(this,TributeRange),this.tribute=tribute,this.tribute.range=this}return _createClass(TributeRange,[{key:"getDocument",value:function(){var iframe;return this.tribute.current.collection&&(iframe=this.tribute.current.collection.iframe),iframe?iframe.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(scrollTo){var coordinates,_this=this,context=this.tribute.current,info=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==info){if(!this.tribute.positionMenu)return void(this.tribute.menu.style.cssText="display: block;");coordinates=this.isContentEditable(context.element)?this.getContentEditableCaretPosition(info.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,info.mentionPosition),this.tribute.menu.style.cssText="top: ".concat(coordinates.top,"px;\n                                     left: ").concat(coordinates.left,"px;\n                                     right: ").concat(coordinates.right,"px;\n                                     bottom: ").concat(coordinates.bottom,"px;\n                                     position: absolute;\n                                     display: block;"),"auto"===coordinates.left&&(this.tribute.menu.style.left="auto"),"auto"===coordinates.top&&(this.tribute.menu.style.top="auto"),scrollTo&&this.scrollIntoView(),window.setTimeout((function(){var menuDimensions={width:_this.tribute.menu.offsetWidth,height:_this.tribute.menu.offsetHeight},menuIsOffScreen=_this.isMenuOffScreen(coordinates,menuDimensions),menuIsOffScreenHorizontally=window.innerWidth>menuDimensions.width&&(menuIsOffScreen.left||menuIsOffScreen.right),menuIsOffScreenVertically=window.innerHeight>menuDimensions.height&&(menuIsOffScreen.top||menuIsOffScreen.bottom);(menuIsOffScreenHorizontally||menuIsOffScreenVertically)&&(_this.tribute.menu.style.cssText="display: none",_this.positionMenuAtCaret(scrollTo))}),0)}else this.tribute.menu.style.cssText="display: none"}},{key:"selectElement",value:function(targetElement,path,offset){var range,elem=targetElement;if(path)for(var i=0;i<path.length;i++){if(void 0===(elem=elem.childNodes[path[i]]))return;for(;elem.length<offset;)offset-=elem.length,elem=elem.nextSibling;0!==elem.childNodes.length||elem.length||(elem=elem.previousSibling)}var sel=this.getWindowSelection();(range=this.getDocument().createRange()).setStart(elem,offset),range.setEnd(elem,offset),range.collapse(!0);try{sel.removeAllRanges()}catch(error){}sel.addRange(range),targetElement.focus()}},{key:"replaceTriggerText",value:function(text,requireLeadingSpace,hasTrailingSpace,originalEvent,item){var info=this.getTriggerInfo(!0,hasTrailingSpace,requireLeadingSpace,this.tribute.allowSpaces,this.tribute.autocompleteMode);if(void 0!==info){var context=this.tribute.current,replaceEvent=new CustomEvent("tribute-replaced",{detail:{item:item,instance:context,context:info,event:originalEvent}});if(this.isContentEditable(context.element)){text+="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";var _endPos=info.mentionPosition+info.mentionText.length;this.tribute.autocompleteMode||(_endPos+=info.mentionTriggerChar.length),this.pasteHtml(text,info.mentionPosition,_endPos)}else{var myField=this.tribute.current.element,textSuffix="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ";text+=textSuffix;var startPos=info.mentionPosition,endPos=info.mentionPosition+info.mentionText.length+textSuffix.length;this.tribute.autocompleteMode||(endPos+=info.mentionTriggerChar.length-1),myField.value=myField.value.substring(0,startPos)+text+myField.value.substring(endPos,myField.value.length),myField.selectionStart=startPos+text.length,myField.selectionEnd=startPos+text.length}context.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),context.element.dispatchEvent(replaceEvent)}}},{key:"pasteHtml",value:function(html,startPos,endPos){var range,sel;sel=this.getWindowSelection(),(range=this.getDocument().createRange()).setStart(sel.anchorNode,startPos),range.setEnd(sel.anchorNode,endPos),range.deleteContents();var el=this.getDocument().createElement("div");el.innerHTML=html;for(var node,lastNode,frag=this.getDocument().createDocumentFragment();node=el.firstChild;)lastNode=frag.appendChild(node);range.insertNode(frag),lastNode&&((range=range.cloneRange()).setStartAfter(lastNode),range.collapse(!0),sel.removeAllRanges(),sel.addRange(range))}},{key:"getWindowSelection",value:function(){return this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow.getSelection():window.getSelection()}},{key:"getNodePositionInParent",value:function(element){if(null===element.parentNode)return 0;for(var i=0;i<element.parentNode.childNodes.length;i++)if(element.parentNode.childNodes[i]===element)return i}},{key:"getContentEditableSelectedPath",value:function(ctx){var sel=this.getWindowSelection(),selected=sel.anchorNode,path=[];if(null!=selected){for(var i,ce=selected.contentEditable;null!==selected&&"true"!==ce;)i=this.getNodePositionInParent(selected),path.push(i),null!==(selected=selected.parentNode)&&(ce=selected.contentEditable);return path.reverse(),{selected:selected,path:path,offset:sel.getRangeAt(0).startOffset}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var context=this.tribute.current,text="";if(this.isContentEditable(context.element)){var selectedElem=this.getWindowSelection().anchorNode;if(null!=selectedElem){var workingNodeContent=selectedElem.textContent,selectStartOffset=this.getWindowSelection().getRangeAt(0).startOffset;workingNodeContent&&selectStartOffset>=0&&(text=workingNodeContent.substring(0,selectStartOffset))}}else{var textComponent=this.tribute.current.element;if(textComponent){var startPos=textComponent.selectionStart;textComponent.value&&startPos>=0&&(text=textComponent.value.substring(0,startPos))}}return text}},{key:"getLastWordInText",value:function(text){var wordsArray;return text=text.replace(/\u00A0/g," "),(wordsArray=this.tribute.autocompleteSeparator?text.split(this.tribute.autocompleteSeparator):text.split(/\s+/))[wordsArray.length-1].trim()}},{key:"getTriggerInfo",value:function(menuAlreadyActive,hasTrailingSpace,requireLeadingSpace,allowSpaces,isAutocomplete){var selected,path,offset,_this2=this,ctx=this.tribute.current;if(this.isContentEditable(ctx.element)){var selectionInfo=this.getContentEditableSelectedPath(ctx);selectionInfo&&(selected=selectionInfo.selected,path=selectionInfo.path,offset=selectionInfo.offset)}else selected=this.tribute.current.element;var effectiveRange=this.getTextPrecedingCurrentSelection(),lastWordOfEffectiveRange=this.getLastWordInText(effectiveRange);if(isAutocomplete)return{mentionPosition:effectiveRange.length-lastWordOfEffectiveRange.length,mentionText:lastWordOfEffectiveRange,mentionSelectedElement:selected,mentionSelectedPath:path,mentionSelectedOffset:offset};if(null!=effectiveRange){var triggerChar,mostRecentTriggerCharPos=-1;if(this.tribute.collection.forEach((function(config){var c=config.trigger,idx=config.requireLeadingSpace?_this2.lastIndexWithLeadingSpace(effectiveRange,c):effectiveRange.lastIndexOf(c);idx>mostRecentTriggerCharPos&&(mostRecentTriggerCharPos=idx,triggerChar=c,requireLeadingSpace=config.requireLeadingSpace)})),mostRecentTriggerCharPos>=0&&(0===mostRecentTriggerCharPos||!requireLeadingSpace||/[\xA0\s]/g.test(effectiveRange.substring(mostRecentTriggerCharPos-1,mostRecentTriggerCharPos)))){var currentTriggerSnippet=effectiveRange.substring(mostRecentTriggerCharPos+triggerChar.length,effectiveRange.length);triggerChar=effectiveRange.substring(mostRecentTriggerCharPos,mostRecentTriggerCharPos+triggerChar.length);var firstSnippetChar=currentTriggerSnippet.substring(0,1),leadingSpace=currentTriggerSnippet.length>0&&(" "===firstSnippetChar||" "===firstSnippetChar);hasTrailingSpace&&(currentTriggerSnippet=currentTriggerSnippet.trim());var regex=allowSpaces?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=regex.test(currentTriggerSnippet),!leadingSpace&&(menuAlreadyActive||!regex.test(currentTriggerSnippet)))return{mentionPosition:mostRecentTriggerCharPos,mentionText:currentTriggerSnippet,mentionSelectedElement:selected,mentionSelectedPath:path,mentionSelectedOffset:offset,mentionTriggerChar:triggerChar}}}}},{key:"lastIndexWithLeadingSpace",value:function(str,trigger){for(var reversedStr=str.split("").reverse().join(""),index=-1,cidx=0,len=str.length;cidx<len;cidx++){for(var firstChar=cidx===str.length-1,leadingSpace=/\s/.test(reversedStr[cidx+1]),match=!0,triggerIdx=trigger.length-1;triggerIdx>=0;triggerIdx--)if(trigger[triggerIdx]!==reversedStr[cidx-triggerIdx]){match=!1;break}if(match&&(firstChar||leadingSpace)){index=str.length-1-cidx;break}}return index}},{key:"isContentEditable",value:function(element){return"INPUT"!==element.nodeName&&"TEXTAREA"!==element.nodeName}},{key:"isMenuOffScreen",value:function(coordinates,menuDimensions){var windowWidth=window.innerWidth,windowHeight=window.innerHeight,doc=document.documentElement,windowLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),windowTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),menuTop="number"==typeof coordinates.top?coordinates.top:windowTop+windowHeight-coordinates.bottom-menuDimensions.height,menuRight="number"==typeof coordinates.right?coordinates.right:coordinates.left+menuDimensions.width,menuBottom="number"==typeof coordinates.bottom?coordinates.bottom:coordinates.top+menuDimensions.height,menuLeft="number"==typeof coordinates.left?coordinates.left:windowLeft+windowWidth-coordinates.right-menuDimensions.width;return{top:menuTop<Math.floor(windowTop),right:menuRight>Math.ceil(windowLeft+windowWidth),bottom:menuBottom>Math.ceil(windowTop+windowHeight),left:menuLeft<Math.floor(windowLeft)}}},{key:"getMenuDimensions",value:function(){var dimensions={width:null,height:null};return this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;",dimensions.width=this.tribute.menu.offsetWidth,dimensions.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",dimensions}},{key:"getTextAreaOrInputUnderlinePosition",value:function(element,position,flipped){var isFirefox=null!==window.mozInnerScreenX,div=this.getDocument().createElement("div");div.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(div);var style=div.style,computed=window.getComputedStyle?getComputedStyle(element):element.currentStyle;style.whiteSpace="pre-wrap","INPUT"!==element.nodeName&&(style.wordWrap="break-word"),style.position="absolute",style.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach((function(prop){style[prop]=computed[prop]})),isFirefox?(style.width="".concat(parseInt(computed.width)-2,"px"),element.scrollHeight>parseInt(computed.height)&&(style.overflowY="scroll")):style.overflow="hidden",div.textContent=element.value.substring(0,position),"INPUT"===element.nodeName&&(div.textContent=div.textContent.replace(/\s/g," "));var span=this.getDocument().createElement("span");span.textContent=element.value.substring(position)||".",div.appendChild(span);var rect=element.getBoundingClientRect(),doc=document.documentElement,windowLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),windowTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),top=0,left=0;this.menuContainerIsBody&&(top=rect.top,left=rect.left);var coordinates={top:top+windowTop+span.offsetTop+parseInt(computed.borderTopWidth)+parseInt(computed.fontSize)-element.scrollTop,left:left+windowLeft+span.offsetLeft+parseInt(computed.borderLeftWidth)},windowWidth=window.innerWidth,windowHeight=window.innerHeight,menuDimensions=this.getMenuDimensions(),menuIsOffScreen=this.isMenuOffScreen(coordinates,menuDimensions);menuIsOffScreen.right&&(coordinates.right=windowWidth-coordinates.left,coordinates.left="auto");var parentHeight=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(menuIsOffScreen.bottom){var scrollStillAvailable=parentHeight-(windowHeight-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);coordinates.bottom=scrollStillAvailable+(windowHeight-rect.top-span.offsetTop),coordinates.top="auto"}return(menuIsOffScreen=this.isMenuOffScreen(coordinates,menuDimensions)).left&&(coordinates.left=windowWidth>menuDimensions.width?windowLeft+windowWidth-menuDimensions.width:windowLeft,delete coordinates.right),menuIsOffScreen.top&&(coordinates.top=windowHeight>menuDimensions.height?windowTop+windowHeight-menuDimensions.height:windowTop,delete coordinates.bottom),this.getDocument().body.removeChild(div),coordinates}},{key:"getContentEditableCaretPosition",value:function(selectedNodePosition){var range,sel=this.getWindowSelection();(range=this.getDocument().createRange()).setStart(sel.anchorNode,selectedNodePosition),range.setEnd(sel.anchorNode,selectedNodePosition),range.collapse(!1);var rect=range.getBoundingClientRect(),doc=document.documentElement,windowLeft=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),windowTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0),coordinates={left:rect.left+windowLeft,top:rect.top+rect.height+windowTop},windowWidth=window.innerWidth,windowHeight=window.innerHeight,menuDimensions=this.getMenuDimensions(),menuIsOffScreen=this.isMenuOffScreen(coordinates,menuDimensions);menuIsOffScreen.right&&(coordinates.left="auto",coordinates.right=windowWidth-rect.left-windowLeft);var parentHeight=this.tribute.menuContainer?this.tribute.menuContainer.offsetHeight:this.getDocument().body.offsetHeight;if(menuIsOffScreen.bottom){var scrollStillAvailable=parentHeight-(windowHeight-(this.tribute.menuContainer?this.tribute.menuContainer.getBoundingClientRect():this.getDocument().body.getBoundingClientRect()).top);coordinates.top="auto",coordinates.bottom=scrollStillAvailable+(windowHeight-rect.top)}return(menuIsOffScreen=this.isMenuOffScreen(coordinates,menuDimensions)).left&&(coordinates.left=windowWidth>menuDimensions.width?windowLeft+windowWidth-menuDimensions.width:windowLeft,delete coordinates.right),menuIsOffScreen.top&&(coordinates.top=windowHeight>menuDimensions.height?windowTop+windowHeight-menuDimensions.height:windowTop,delete coordinates.bottom),this.menuContainerIsBody||(coordinates.left=coordinates.left?coordinates.left-this.tribute.menuContainer.offsetLeft:coordinates.left,coordinates.top=coordinates.top?coordinates.top-this.tribute.menuContainer.offsetTop:coordinates.top),coordinates}},{key:"scrollIntoView",value:function(elem){var clientRect,e=this.menu;if(void 0!==e){for(;void 0===clientRect||0===clientRect.height;)if(0===(clientRect=e.getBoundingClientRect()).height&&(void 0===(e=e.childNodes[0])||!e.getBoundingClientRect))return;var elemTop=clientRect.top,elemBottom=elemTop+clientRect.height;if(elemTop<0)window.scrollTo(0,window.pageYOffset+clientRect.top-20);else if(elemBottom>window.innerHeight){var maxY=window.pageYOffset+clientRect.top-20;maxY-window.pageYOffset>100&&(maxY=window.pageYOffset+100);var targetY=window.pageYOffset-(window.innerHeight-elemBottom);targetY>maxY&&(targetY=maxY),window.scrollTo(0,targetY)}}}},{key:"menuContainerIsBody",get:function(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}}]),TributeRange}(),TributeSearch=function(){function TributeSearch(tribute){_classCallCheck(this,TributeSearch),this.tribute=tribute,this.tribute.search=this}return _createClass(TributeSearch,[{key:"simpleFilter",value:function(pattern,array){var _this=this;return array.filter((function(string){return _this.test(pattern,string)}))}},{key:"test",value:function(pattern,string){return null!==this.match(pattern,string)}},{key:"match",value:function(pattern,string,opts){opts=opts||{},string.length;var pre=opts.pre||"",post=opts.post||"",compareString=opts.caseSensitive&&string||string.toLowerCase();if(opts.skip)return{rendered:string,score:0};pattern=opts.caseSensitive&&pattern||pattern.toLowerCase();var patternCache=this.traverse(compareString,pattern,0,0,[]);return patternCache?{rendered:this.render(string,patternCache.cache,pre,post),score:patternCache.score}:null}},{key:"traverse",value:function(string,pattern,stringIndex,patternIndex,patternCache){if(this.tribute.autocompleteSeparator&&(pattern=pattern.split(this.tribute.autocompleteSeparator).splice(-1)[0]),pattern.length===patternIndex)return{score:this.calculateScore(patternCache),cache:patternCache.slice()};if(!(string.length===stringIndex||pattern.length-patternIndex>string.length-stringIndex)){for(var best,temp,c=pattern[patternIndex],index=string.indexOf(c,stringIndex);index>-1;){if(patternCache.push(index),temp=this.traverse(string,pattern,index+1,patternIndex+1,patternCache),patternCache.pop(),!temp)return best;(!best||best.score<temp.score)&&(best=temp),index=string.indexOf(c,index+1)}return best}}},{key:"calculateScore",value:function(patternCache){var score=0,temp=1;return patternCache.forEach((function(index,i){i>0&&(patternCache[i-1]+1===index?temp+=temp+1:temp=1),score+=temp})),score}},{key:"render",value:function(string,indices,pre,post){var rendered=string.substring(0,indices[0]);return indices.forEach((function(index,i){rendered+=pre+string[index]+post+string.substring(index+1,indices[i+1]?indices[i+1]:string.length)})),rendered}},{key:"filter",value:function(pattern,arr,opts){var _this2=this;return opts=opts||{},arr.reduce((function(prev,element,idx,arr){var str=element;opts.extract&&((str=opts.extract(element))||(str=""));var rendered=_this2.match(pattern,str,opts);return null!=rendered&&(prev[prev.length]={string:rendered.rendered,score:rendered.score,index:idx,original:element}),prev}),[]).sort((function(a,b){var compare=b.score-a.score;return compare||a.index-b.index}))}}]),TributeSearch}();return function(){function Tribute(_ref){var t,_this=this,_ref$values=_ref.values,values=void 0===_ref$values?null:_ref$values,_ref$loadingItemTempl=_ref.loadingItemTemplate,loadingItemTemplate=void 0===_ref$loadingItemTempl?null:_ref$loadingItemTempl,_ref$iframe=_ref.iframe,iframe=void 0===_ref$iframe?null:_ref$iframe,_ref$selectClass=_ref.selectClass,selectClass=void 0===_ref$selectClass?"highlight":_ref$selectClass,_ref$containerClass=_ref.containerClass,containerClass=void 0===_ref$containerClass?"local_modcomments-tribute-container":_ref$containerClass,_ref$itemClass=_ref.itemClass,itemClass=void 0===_ref$itemClass?"":_ref$itemClass,_ref$trigger=_ref.trigger,trigger=void 0===_ref$trigger?"@":_ref$trigger,_ref$autocompleteMode=_ref.autocompleteMode,autocompleteMode=void 0!==_ref$autocompleteMode&&_ref$autocompleteMode,_ref$autocompleteSepa=_ref.autocompleteSeparator,autocompleteSeparator=void 0===_ref$autocompleteSepa?null:_ref$autocompleteSepa,_ref$selectTemplate=_ref.selectTemplate,selectTemplate=void 0===_ref$selectTemplate?null:_ref$selectTemplate,_ref$menuItemTemplate=_ref.menuItemTemplate,menuItemTemplate=void 0===_ref$menuItemTemplate?null:_ref$menuItemTemplate,_ref$lookup=_ref.lookup,lookup=void 0===_ref$lookup?"key":_ref$lookup,_ref$fillAttr=_ref.fillAttr,fillAttr=void 0===_ref$fillAttr?"value":_ref$fillAttr,_ref$collection=_ref.collection,collection=void 0===_ref$collection?null:_ref$collection,_ref$menuContainer=_ref.menuContainer,menuContainer=void 0===_ref$menuContainer?null:_ref$menuContainer,_ref$noMatchTemplate=_ref.noMatchTemplate,noMatchTemplate=void 0===_ref$noMatchTemplate?null:_ref$noMatchTemplate,_ref$requireLeadingSp=_ref.requireLeadingSpace,requireLeadingSpace=void 0===_ref$requireLeadingSp||_ref$requireLeadingSp,_ref$allowSpaces=_ref.allowSpaces,allowSpaces=void 0!==_ref$allowSpaces&&_ref$allowSpaces,_ref$replaceTextSuffi=_ref.replaceTextSuffix,replaceTextSuffix=void 0===_ref$replaceTextSuffi?null:_ref$replaceTextSuffi,_ref$positionMenu=_ref.positionMenu,positionMenu=void 0===_ref$positionMenu||_ref$positionMenu,_ref$spaceSelectsMatc=_ref.spaceSelectsMatch,spaceSelectsMatch=void 0!==_ref$spaceSelectsMatc&&_ref$spaceSelectsMatc,_ref$searchOpts=_ref.searchOpts,searchOpts=void 0===_ref$searchOpts?{}:_ref$searchOpts,_ref$menuItemLimit=_ref.menuItemLimit,menuItemLimit=void 0===_ref$menuItemLimit?null:_ref$menuItemLimit,_ref$menuShowMinLengt=_ref.menuShowMinLength,menuShowMinLength=void 0===_ref$menuShowMinLengt?0:_ref$menuShowMinLengt;if(_classCallCheck(this,Tribute),this.autocompleteMode=autocompleteMode,this.autocompleteSeparator=autocompleteSeparator,this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=menuContainer,this.allowSpaces=allowSpaces,this.replaceTextSuffix=replaceTextSuffix,this.positionMenu=positionMenu,this.hasTrailingSpace=!1,this.spaceSelectsMatch=spaceSelectsMatch,this.autocompleteMode&&(trigger="",allowSpaces=!1),values)this.collection=[{trigger:trigger,iframe:iframe,selectClass:selectClass,containerClass:containerClass,itemClass:itemClass,selectTemplate:(selectTemplate||Tribute.defaultSelectTemplate).bind(this),menuItemTemplate:(menuItemTemplate||Tribute.defaultMenuItemTemplate).bind(this),noMatchTemplate:(t=noMatchTemplate,"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(_this):noMatchTemplate||function(){return"<li>No Match Found!</li>"}.bind(_this)),lookup:lookup,fillAttr:fillAttr,values:values,loadingItemTemplate:loadingItemTemplate,requireLeadingSpace:requireLeadingSpace,searchOpts:searchOpts,menuItemLimit:menuItemLimit,menuShowMinLength:menuShowMinLength}];else{if(!collection)throw new Error("[Tribute] No collection specified.");this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=collection.map((function(item){return{trigger:item.trigger||trigger,iframe:item.iframe||iframe,selectClass:item.selectClass||selectClass,containerClass:item.containerClass||containerClass,itemClass:item.itemClass||itemClass,selectTemplate:(item.selectTemplate||Tribute.defaultSelectTemplate).bind(_this),menuItemTemplate:(item.menuItemTemplate||Tribute.defaultMenuItemTemplate).bind(_this),noMatchTemplate:function(t){return"string"==typeof t?""===t.trim()?null:t:"function"==typeof t?t.bind(_this):noMatchTemplate||function(){return"<li>No Match Found!</li>"}.bind(_this)}(noMatchTemplate),lookup:item.lookup||lookup,fillAttr:item.fillAttr||fillAttr,values:item.values,loadingItemTemplate:item.loadingItemTemplate,requireLeadingSpace:item.requireLeadingSpace,searchOpts:item.searchOpts||searchOpts,menuItemLimit:item.menuItemLimit||menuItemLimit,menuShowMinLength:item.menuShowMinLength||menuShowMinLength}}))}new TributeRange(this),new TributeEvents(this),new TributeMenuEvents(this),new TributeSearch(this)}return _createClass(Tribute,[{key:"triggers",value:function(){return this.collection.map((function(config){return config.trigger}))}},{key:"attach",value:function(el){if(!el)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&el instanceof jQuery&&(el=el.get()),el.constructor===NodeList||el.constructor===HTMLCollection||el.constructor===Array)for(var length=el.length,i=0;i<length;++i)this._attach(el[i]);else this._attach(el)}},{key:"_attach",value:function(el){el.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+el.nodeName),this.ensureEditable(el),this.events.bind(el),el.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(element){if(-1===Tribute.inputTypes().indexOf(element.nodeName)){if(!element.contentEditable)throw new Error("[Tribute] Cannot bind to "+element.nodeName);element.contentEditable=!0}}},{key:"createMenu",value:function(containerClass){var wrapper=this.range.getDocument().createElement("div"),ul=this.range.getDocument().createElement("ul");return wrapper.className=containerClass,wrapper.appendChild(ul),this.menuContainer?this.menuContainer.appendChild(wrapper):this.range.getDocument().body.appendChild(wrapper)}},{key:"showMenuFor",value:function(element,scrollTo){var _this2=this;if(!this.isActive||this.current.element!==element||this.current.mentionText!==this.currentMentionTextSnapshot){this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),element.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText="");var processValues=function(values){if(_this2.isActive){var items=_this2.search.filter(_this2.current.mentionText,values,{pre:_this2.current.collection.searchOpts.pre||"<span>",post:_this2.current.collection.searchOpts.post||"</span>",skip:_this2.current.collection.searchOpts.skip,extract:function(el){if("string"==typeof _this2.current.collection.lookup)return el[_this2.current.collection.lookup];if("function"==typeof _this2.current.collection.lookup)return _this2.current.collection.lookup(el,_this2.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});_this2.current.collection.menuItemLimit&&(items=items.slice(0,_this2.current.collection.menuItemLimit)),_this2.current.filteredItems=items;var ul=_this2.menu.querySelector("ul");if(_this2.range.positionMenuAtCaret(scrollTo),!items.length){var noMatchEvent=new CustomEvent("tribute-no-match",{detail:_this2.menu});return _this2.current.element.dispatchEvent(noMatchEvent),void("function"==typeof _this2.current.collection.noMatchTemplate&&!_this2.current.collection.noMatchTemplate()||!_this2.current.collection.noMatchTemplate?_this2.hideMenu():"function"==typeof _this2.current.collection.noMatchTemplate?ul.innerHTML=_this2.current.collection.noMatchTemplate():ul.innerHTML=_this2.current.collection.noMatchTemplate)}ul.innerHTML="";var fragment=_this2.range.getDocument().createDocumentFragment();items.forEach((function(item,index){var li=_this2.range.getDocument().createElement("li");li.setAttribute("data-index",index),li.className=_this2.current.collection.itemClass,li.addEventListener("mousemove",(function(e){var _this2$_findLiTarget2=_slicedToArray(_this2._findLiTarget(e.target),2),index=(_this2$_findLiTarget2[0],_this2$_findLiTarget2[1]);0!==e.movementY&&_this2.events.setActiveLi(index)})),_this2.menuSelected===index&&li.classList.add(_this2.current.collection.selectClass),li.innerHTML=_this2.current.collection.menuItemTemplate(item),fragment.appendChild(li)})),ul.appendChild(fragment)}};"function"==typeof this.current.collection.values?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(scrollTo)),this.current.collection.values(this.current.mentionText,processValues)):processValues(this.current.collection.values)}}},{key:"_findLiTarget",value:function(el){if(!el)return[];var index=el.getAttribute("data-index");return index?[el,index]:this._findLiTarget(el.parentNode)}},{key:"showMenuForCollection",value:function(element,collectionIndex){element!==document.activeElement&&this.placeCaretAtEnd(element),this.current.collection=this.collection[collectionIndex||0],this.current.externalTrigger=!0,this.current.element=element,element.isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(element,this.current.collection.trigger),this.showMenuFor(element)}},{key:"placeCaretAtEnd",value:function(el){if(el.focus(),void 0!==window.getSelection&&void 0!==document.createRange){var range=document.createRange();range.selectNodeContents(el),range.collapse(!1);var sel=window.getSelection();sel.removeAllRanges(),sel.addRange(range)}else if(void 0!==document.body.createTextRange){var textRange=document.body.createTextRange();textRange.moveToElementText(el),textRange.collapse(!1),textRange.select()}}},{key:"insertTextAtCursor",value:function(text){var sel,range;(range=(sel=window.getSelection()).getRangeAt(0)).deleteContents();var textNode=document.createTextNode(text);range.insertNode(textNode),range.selectNodeContents(textNode),range.collapse(!1),sel.removeAllRanges(),sel.addRange(range)}},{key:"insertAtCaret",value:function(textarea,text){var scrollPos=textarea.scrollTop,caretPos=textarea.selectionStart,front=textarea.value.substring(0,caretPos),back=textarea.value.substring(textarea.selectionEnd,textarea.value.length);textarea.value=front+text+back,caretPos+=text.length,textarea.selectionStart=caretPos,textarea.selectionEnd=caretPos,textarea.focus(),textarea.scrollTop=scrollPos}},{key:"hideMenu",value:function(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}},{key:"selectItemAtIndex",value:function(index,originalEvent){if("number"==typeof(index=parseInt(index))&&!isNaN(index)){var item=this.current.filteredItems[index],content=this.current.collection.selectTemplate(item);null!==content&&this.replaceText(content,originalEvent,item)}}},{key:"replaceText",value:function(content,originalEvent,item){this.range.replaceTriggerText(content,!0,!0,originalEvent,item)}},{key:"_append",value:function(collection,newValues,replace){if("function"==typeof collection.values)throw new Error("Unable to append to values, as it is a function.");collection.values=replace?newValues:collection.values.concat(newValues)}},{key:"append",value:function(collectionIndex,newValues,replace){var index=parseInt(collectionIndex);if("number"!=typeof index)throw new Error("please provide an index for the collection to update.");var collection=this.collection[index];this._append(collection,newValues,replace)}},{key:"appendCurrent",value:function(newValues,replace){if(!this.isActive)throw new Error("No active state. Please use append instead and pass an index.");this._append(this.current.collection,newValues,replace)}},{key:"detach",value:function(el){if(!el)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if("undefined"!=typeof jQuery&&el instanceof jQuery&&(el=el.get()),el.constructor===NodeList||el.constructor===HTMLCollection||el.constructor===Array)for(var length=el.length,i=0;i<length;++i)this._detach(el[i]);else this._detach(el)}},{key:"_detach",value:function(el){var _this3=this;this.events.unbind(el),el.tributeMenu&&this.menuEvents.unbind(el.tributeMenu),setTimeout((function(){el.removeAttribute("data-tribute"),_this3.isActive=!1,el.tributeMenu&&el.tributeMenu.remove()}))}},{key:"isActive",get:function(){return this._isActive},set:function(val){if(this._isActive!=val&&(this._isActive=val,this.current.element)){var noMatchEvent=new CustomEvent("tribute-active-".concat(val));this.current.element.dispatchEvent(noMatchEvent)}}}],[{key:"defaultSelectTemplate",value:function(item){return void 0===item?"".concat(this.current.collection.trigger).concat(this.current.mentionText):this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+item.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+item.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(matchItem){return matchItem.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]),Tribute}()},"object"==typeof exports&&"undefined"!=typeof module?module.exports=factory():"function"==typeof define&&define.amd?define("local_modcomments/tribute",factory):(global=global||self).Tribute=factory();

//# sourceMappingURL=tribute.min.js.map